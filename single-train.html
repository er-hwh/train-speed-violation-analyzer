<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Single Train ‚Äì Home Signal Violation Analysis</title>

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- LEAFLET -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; width:100%; }

#topPanel {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  width:96%;
  max-width:1300px;
}

.stat {
  font-weight:700;
  font-size:15px;
}

.tooltip-card {
  font-family:Segoe UI, Arial;
  font-size:13px;
  line-height:1.4;
}
</style>
</head>

<body>

<!-- TOP PANEL -->
<div id="topPanel">
  <div class="card shadow">
    <div class="card-body row g-2 align-items-center">

      <div class="col-md-2"><b>üöÜ Train:</b> <span id="trainInfo">NA</span></div>
      <div class="col-md-2"><b>üìÖ Date:</b> <span id="dateInfo">NA</span></div>

      <div class="col-md-3">
        <label class="form-label mb-0">SPM GPS Data</label>
        <input type="file" id="spmFile" class="form-control" accept=".csv,.xlsx,.xls">
      </div>

      <div class="col-md-3">
        <label class="form-label mb-0">FSD (Home Signals)</label>
        <input type="file" id="fsdFile" class="form-control" accept=".csv,.xlsx,.xls">
      </div>

      <div class="col-md-2 d-grid">
        <button class="btn btn-primary" id="analyzeBtn">Analyze</button>
      </div>

      <div class="col-12 mt-2 d-flex justify-content-between align-items-center flex-wrap">
        <div>
          <label class="me-2">
            <input type="radio" name="trainType" value="PASS" checked>
            Passenger (50 kmph)
          </label>
          <label class="ms-2">
            <input type="radio" name="trainType" value="GOODS">
            Goods (30 kmph)
          </label>
        </div>

        <div class="stat text-danger">
          üö® Violations: <span id="statViol">0</span>
        </div>

        <div class="stat text-primary">
          ‚ö° Max @ Home: <span id="statMaxHome">0</span> kmph
        </div>

        <button class="btn btn-sm btn-success" onclick="exportViolations()">
          Export Violations CSV
        </button>
      </div>

    </div>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- SCRIPTS (ORDER IS IMPORTANT) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= CONFIG ================= */
const PASS_LIMIT = 50;
const GOODS_LIMIT = 30;

const STOP_SPEED = 1;
const STOP_MIN_SEC = 20;
const HOME_RADIUS = 80;

/* ================= GLOBALS ================= */
let map, layerGroup;
let spmData = [];
let fsdHomes = [];
let stopReport = [];
let violationReport = [];

/* ================= URL PARAMS ================= */
const params = new URLSearchParams(window.location.search);
const trainNo = params.get("train") || "NA";
const dateStr = params.get("date") || "NA";

document.getElementById("trainInfo").innerText = trainNo;
document.getElementById("dateInfo").innerText = dateStr;

/* ================= MAP INIT ================= */
map = L.map("map", {
  center: [22.5, 88.3],
  zoom: 6,
  preferCanvas: true
});

L.tileLayer("https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", {
  maxZoom: 20,
  detectRetina: true,
  subdomains: ["mt0","mt1","mt2","mt3"]
}).addTo(map);

layerGroup = L.layerGroup().addTo(map);

/* ================= ICONS ================= */
const startIcon = L.divIcon({ html:"üü¢ START", iconSize:[70,20], className:"" });
const endIcon   = L.divIcon({ html:"üî¥ END", iconSize:[60,20], className:"" });

const homeOKIcon = L.divIcon({
  html: "üö¶",
  iconSize: [24,24],
  className: "text-success"
});

const homeViolIcon = L.divIcon({
  html: "üö¶",
  iconSize: [24,24],
  className: "text-danger"
});

const stopIcon = L.divIcon({
  html: "üìç",
  iconSize: [24,24],
  className: ""
});

/* ================= HELPERS ================= */
function find(row, keys) {
  for (let k in row) {
    const ck = k.toLowerCase().replace(/\s|\./g,"");
    for (let key of keys)
      if (ck.includes(key)) return row[k];
  }
  return null;
}

function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2;

  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/* ================= PARSER ================= */
function parseFile(file, callback) {
  if (!file) return;
  const ext = file.name.split(".").pop().toLowerCase();

  if (ext === "csv") {
    Papa.parse(file, {
      header:true,
      skipEmptyLines:true,
      complete: res => callback(res.data)
    });
  } else {
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type:"array" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      callback(XLSX.utils.sheet_to_json(sheet, { defval:"" }));
    };
    reader.readAsArrayBuffer(file);
  }
}

/* ================= LOADERS ================= */
function loadSPM(data) {
  spmData = [];
  data.forEach(r => {
    const lat = parseFloat(find(r,["lat","latitude"]));
    const lon = parseFloat(find(r,["lon","longitude"]));
    const speed = parseFloat(find(r,["speed"]));
    const time = find(r,["time","logging"]);
    if (!isNaN(lat) && !isNaN(lon) && !isNaN(speed))
      spmData.push({ lat, lon, speed, time });
  });
}

function loadFSD(data) {
  fsdHomes = [];
  data.forEach(r => {
    if (!r.Type || r.Type.toUpperCase() !== "HOME") return;
    const lat = parseFloat(r.Latitude);
    const lon = parseFloat(r.Longitude);
    const station = r.Station?.toUpperCase();
    if (!isNaN(lat) && !isNaN(lon))
      fsdHomes.push({ station, lat, lon });
  });
}

/* ================= ANALYZE ================= */
document.getElementById("analyzeBtn").onclick = () => {
  const spmFile = document.getElementById("spmFile").files[0];
  const fsdFile = document.getElementById("fsdFile").files[0];

  if (!spmFile || !fsdFile) return alert("Upload both files");

  layerGroup.clearLayers();
  stopReport = [];
  violationReport = [];

  parseFile(spmFile, d1 => {
    loadSPM(d1);
    parseFile(fsdFile, d2 => {
      loadFSD(d2);
      runAnalysis();
    });
  });
};

/* ================= CORE ================= */
function getLimit() {
  const sel = document.querySelector("input[name='trainType']:checked").value;
  return sel === "PASS" ? PASS_LIMIT : GOODS_LIMIT;
}

function runAnalysis() {
  const LIMIT = getLimit();
  let bounds = [];
  let route = [];
  let stopBuffer = [];
  let currentStop = null;

  /* ===== ROUTE & STOP DETECT ===== */
  spmData.forEach(p => {
    const pos = [p.lat, p.lon];
    route.push(pos);
    bounds.push(pos);

    if (p.speed <= STOP_SPEED) {
      stopBuffer.push(p);
      if (!currentStop)
        currentStop = { start:p.time, lat:p.lat, lon:p.lon };
    } else {
      finalizeStop(stopBuffer, currentStop);
      stopBuffer = [];
      currentStop = null;
    }
  });
  finalizeStop(stopBuffer, currentStop);

  /* ===== ROUTE LINE ===== */
  L.polyline(route, { color:"#1E90FF", weight:3 }).addTo(layerGroup);

  /* ===== START / END ===== */
  if (route.length) {
    L.marker(route[0], { icon:startIcon }).addTo(layerGroup);
    L.marker(route[route.length-1], { icon:endIcon }).addTo(layerGroup);
  }

  /* ===== HOME ‚Üí STOP VIOLATION LOGIC ===== */
  let homesViol = 0;
  let maxSpeed = 0;

  fsdHomes.forEach(home => {
    const stop = findNearestStop(home);
    if (!stop) return;

    const cross = findSPMBeforeStop(home, stop);
    if (!cross) return;

    maxSpeed = Math.max(maxSpeed, cross.speed);
    const violated = cross.speed > LIMIT;
    if (violated) homesViol++;

    if (violated) {
      violationReport.push({
        Station: home.station,
        Speed: cross.speed,
        Limit: LIMIT,
        Time: cross.time
      });
    }

    /* HOME MARKER */
    L.marker([home.lat, home.lon], {
      icon: violated ? homeViolIcon : homeOKIcon
    })
    .bindTooltip(
      `üö¶ HOME SIGNAL<br><b>${home.station}</b><br>
       Speed: ${cross.speed} / ${LIMIT} kmph<br>
       Status: ${violated ? "VIOLATION" : "OK"}`,
      { sticky:true }
    )
    .addTo(layerGroup);

    /* HOME ‚Üí STOP LINE */
    L.polyline(
      [[home.lat, home.lon],[stop.lat, stop.lon]],
      { color: violated ? "#ff0000" : "#ff9900", weight:2, dashArray:"5,5" }
    ).addTo(layerGroup);
  });

  document.getElementById("statViol").innerText = homesViol;
  document.getElementById("statMaxHome").innerText = maxSpeed.toFixed(1);

  map.fitBounds(bounds, { padding:[40,40] });
}

/* ================= MATCH ================= */
function findNearestStop(home) {
  let best = null, min = Infinity;
  stopReport.forEach(s => {
    const d = distanceMeters(home.lat, home.lon, s.lat, s.lon);
    if (d < min && d < HOME_RADIUS*3) {
      min = d;
      best = s;
    }
  });
  return best;
}

function findSPMBeforeStop(home, stop) {
  let best = null, min = Infinity;
  spmData.forEach(p => {
    if (p.time >= stop.start) return;
    const d = distanceMeters(home.lat, home.lon, p.lat, p.lon);
    if (d < min) {
      min = d;
      best = p;
    }
  });
  return best;
}

/* ================= STOP FINALIZER ================= */
function finalizeStop(buffer, meta) {
  if (!buffer.length || !meta) return;
  if (buffer.length < STOP_MIN_SEC) return;

  const avgLat = buffer.reduce((s,p)=>s+p.lat,0)/buffer.length;
  const avgLon = buffer.reduce((s,p)=>s+p.lon,0)/buffer.length;
  const duration = buffer.length;

  const stopObj = {
    start: meta.start,
    end: buffer[buffer.length-1].time,
    lat: avgLat,
    lon: avgLon,
    duration
  };

  stopReport.push(stopObj);

  L.marker([avgLat, avgLon], { icon:stopIcon })
    .bindTooltip(
      `<div class="tooltip-card">
        <b>üìç STOPPAGE</b><br>
        <b>Start:</b> ${stopObj.start}<br>
        <b>End:</b> ${stopObj.end}<br>
        <b>Duration:</b> ${duration} sec<br>
        <i>Approach from previous HOME</i>
      </div>`,
      { sticky:true, direction:"top", opacity:0.95 }
    )
    .addTo(layerGroup);
}

/* ================= EXPORT ================= */
function exportViolations() {
  if (!violationReport.length) return alert("No violations");

  let csv = "Station,Speed,Limit,Time\n";
  violationReport.forEach(v => {
    csv += `${v.Station},${v.Speed},${v.Limit},${v.Time}\n`;
  });

  const blob = new Blob([csv], { type:"text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `violations_${trainNo}_${dateStr}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
